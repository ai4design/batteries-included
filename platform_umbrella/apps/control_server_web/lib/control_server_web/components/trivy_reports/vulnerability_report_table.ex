defmodule ControlServerWeb.VulnerabilityReportTable do
  use ControlServerWeb, :html
  import K8s.Resource.FieldAccessors, only: [name: 1, namespace: 1]
  alias CommonCore.ApiVersionKind

  defp report_url(report) do
    kind = ApiVersionKind.resource_type!(report)
    ~p"/trivy_reports/#{kind}/#{namespace(report)}/#{name(report)}"
  end

  def vulnerability_reports_table(assigns) do
    ~H"""
    <.table rows={@reports}>
      <:col :let={report} label="Name"><%= name(report) %></:col>
      <:col :let={report} label="Image"><%= get_in(report, ~w(report artifact repository)) %></:col>
      <:col :let={report} label="Critical">
        <%= get_in(report, ~w(report summary criticalCount)) %>
      </:col>
      <:col :let={report} label="High"><%= get_in(report, ~w(report summary highCount)) %></:col>
      <:action :let={report}>
        <.a navigate={report_url(report)} variant="styled">
          Show Report
        </.a>
      </:action>
    </.table>
    """
  end
end
